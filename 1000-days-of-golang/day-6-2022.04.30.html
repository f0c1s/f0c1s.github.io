<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
blog.f0c1s.com/1000-days-of-golang/day 6
</title>
<script src="../setup.js" async></script>
<link rel="stylesheet" href="../index.css" />
<link rel="stylesheet" href="../highlight/styles/monokai.min.css"/>
<script src="../highlight/highlight.min.js"></script>
</head>
<body onload="setup()">
<h1>
/f0c1s/blog/1000-days-of-golang/Day 6
</h1>
<p>2022.04.30 Saturday</p>
<p>
<a href="../index.html">blog</a>
<a href="../1000-days-of-golang/1000-days-of-golang.html">1000-days-of-golang</a>
<a href="../1000-days-of-golang/day-6-2022.04.30.html">+ Day 6</a>
</p>
<h2 id="content">Content</h2>
<ul>
<li>Web Assembly</li>
</ul>
<h2 id="web-assembly">Web Assembly</h2>
<p>This is my math.go file.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%d*%d = %d</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> multiply<span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">))</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> add<span class="op">(</span>a<span class="op">,</span> b <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">+</span> b</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> multiply<span class="op">(</span>a<span class="op">,</span> b <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">*</span> b</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And now I am going to compile and execute the go code via web
assembly.</p>
<pre class="shell"><code>
# This command creates a binary file which is compatible with WASM
GOOS=js GOARCH=wasm go build -o math.wasm math.go


# Getting information about binary file
file math.wasm
math.wasm: WebAssembly (wasm) binary module version 0x1 (MVP)

# Size info
du -sh math.wasm
1.9M    math.wasm


# Copying WASM exec file, it has boilerplate execution information
cp &quot;$(go env GOROOT)/misc/wasm/wasm_exec.js&quot; .


# Executing
node wasm_exec.js math.wasm
10*20 = 200
</code></pre>
<p>Using the links below, we are going to reduce size of the wasm file
by a lot.</p>
<ul>
<li><a
href="https://dev.bitolog.com/minimizing-go-webassembly-binary-size/">Making
go wasm smaler</a></li>
<li><a href="https://tinygo.org/">TinyGo</a></li>
</ul>
<h2 id="tinygo">TinyGo</h2>
<ul>
<li><a href="https://tinygo.org/getting-started/install/macos/">TinyGo
getting started</a></li>
</ul>
<pre class="shell"><code>brew tap tinygo-org/tools
brew install tinygo

tinygo build -o tiny-math.wasm -target wasm math.go

du -sh *.wasm
1.9M    math.wasm
348K    tiny-math.wasm # Notice the massive drop from 1.9M


cp &quot;$(go env GOROOT)/misc/wasm/wasm_exec.js&quot; .
node wasm_exec.js math.wasm
10*20 = 200

# go wasm exec cannot execute tinygo binary
node wasm_exec.js tiny-math.wasm
[TypeError: WebAssembly.instantiate(): Import #0 module=&quot;wasi_snapshot_preview1&quot; error: module is not an object or function]

# Need tinygo wasm file for executing tinygo compiled binary
cp $(tinygo env TINYGOROOT)/targets/wasm_exec.js .
node wasm_exec.js math.wasm
[TypeError: WebAssembly.instantiate(): Import #0 module=&quot;go&quot; error: module is not an object or function]

node wasm_exec.js tiny-math.wasm
10*20 = 200
</code></pre>
<p>With <code>--no-debug</code> we can further decrease the size.</p>
<pre class="shell"><code>tinygo build -o tiny-math.wasm --no-debug -target wasm math.go

# du -sh
140K    tiny-math.wasm</code></pre>
</body>
</html>
